{% extends "base.html" %}
{% block title %}Point of Sale - Takwimu+{% endblock %}
{% block content %}
<div class="container-fluid">
    <h2 class="mb-4"><i class="bi bi-cart3"></i> Point of Sale</h2>

    <div class="row">
        <!-- Products Grid -->
        <div class="col-lg-8 mb-4">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-grid"></i> Products</span>
                    <input type="text" id="search-products" class="form-control form-control-sm"
                           style="max-width: 200px;" placeholder="Search products...">
                </div>
                <div class="card-body">
                    <div class="row g-2" id="products-grid">
                        {% if products %}
                            {% for product in products %}
                            <div class="col-6 col-md-4 col-xl-3 product-item">
                                <button class="btn btn-outline-secondary w-100 h-100 py-3 product-btn text-start"
                                        data-id="{{ product.id }}"
                                        data-name="{{ product.name }}"
                                        data-price="{{ product.selling_price }}"
                                        data-cost="{{ product.buying_price }}"
                                        data-stock="{{ product.stock }}">
                                    <div class="fw-bold text-truncate">{{ product.name }}</div>
                                    <div class="text-success">TZS {{ "{:,.0f}".format(product.selling_price) }}</div>
                                    <small class="text-muted">Stock: {{ product.stock }}</small>
                                </button>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="col-12 text-center py-5">
                                <i class="bi bi-inbox fs-1 text-muted"></i>
                                <p class="text-muted mt-2">No products with stock available.</p>
                                <a href="{{ url_for('main.products') }}" class="btn btn-success">
                                    <i class="bi bi-plus"></i> Add Products
                                </a>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Cart -->
        <div class="col-lg-4">
            <div class="card sticky-top" style="top: 80px;">
                <div class="card-header bg-success text-white">
                    <i class="bi bi-cart"></i> Cart
                    <span class="badge bg-white text-success float-end" id="cart-count">0</span>
                </div>
                <div class="card-body">
                    <div id="cart-items" style="min-height: 150px; max-height: 300px; overflow-y: auto;">
                        <p class="text-muted text-center py-4">Cart is empty</p>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span class="fs-5">Total:</span>
                        <span class="fs-4 fw-bold text-success" id="cart-total">TZS 0</span>
                    </div>
                    <div class="mb-3">
                        <label class="form-label"><i class="bi bi-credit-card"></i> Payment Method</label>
                        <select class="form-select" id="payment-method">
                            <option value="cash">Cash</option>
                            <option value="mpesa">M-Pesa</option>
                            <option value="airtel">Airtel Money</option>
                            <option value="tigopesa">Tigo Pesa</option>
                            <option value="halopesa">Halo Pesa</option>
                        </select>
                    </div>
                    <button class="btn btn-success w-100 btn-lg" id="complete-sale" disabled>
                        <i class="bi bi-check-circle"></i> Complete Sale
                    </button>
                    <button class="btn btn-outline-danger w-100 mt-2" id="clear-cart" style="display: none;">
                        <i class="bi bi-trash"></i> Clear Cart
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let cart = [];

// Product search
document.getElementById('search-products').addEventListener('input', function(e) {
    const search = e.target.value.toLowerCase();
    document.querySelectorAll('.product-item').forEach(item => {
        const name = item.querySelector('.product-btn').dataset.name.toLowerCase();
        item.style.display = name.includes(search) ? '' : 'none';
    });
});

// Add to cart
document.querySelectorAll('.product-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const id = parseInt(this.dataset.id);
        const name = this.dataset.name;
        const price = parseFloat(this.dataset.price);
        const cost = parseFloat(this.dataset.cost);
        const stock = parseInt(this.dataset.stock);

        const existing = cart.find(item => item.product_id === id);
        if (existing) {
            if (existing.quantity < stock) {
                existing.quantity++;
            } else {
                alert('Not enough stock! Only ' + stock + ' available.');
                return;
            }
        } else {
            cart.push({
                product_id: id,
                name: name,
                selling_price: price,
                buying_price: cost,
                quantity: 1,
                max_stock: stock
            });
        }
        updateCart();
    });
});

function updateCart() {
    const container = document.getElementById('cart-items');
    const totalEl = document.getElementById('cart-total');
    const countEl = document.getElementById('cart-count');
    const completeBtn = document.getElementById('complete-sale');
    const clearBtn = document.getElementById('clear-cart');

    if (cart.length === 0) {
        container.innerHTML = '<p class="text-muted text-center py-4">Cart is empty</p>';
        totalEl.textContent = 'TZS 0';
        countEl.textContent = '0';
        completeBtn.disabled = true;
        clearBtn.style.display = 'none';
        return;
    }

    let html = '';
    let total = 0;
    let totalItems = 0;

    cart.forEach((item, index) => {
        const subtotal = item.selling_price * item.quantity;
        total += subtotal;
        totalItems += item.quantity;

        html += `
            <div class="d-flex justify-content-between align-items-center mb-2 pb-2 border-bottom">
                <div class="flex-grow-1">
                    <div class="fw-bold">${item.name}</div>
                    <small class="text-muted">${item.quantity} x TZS ${item.selling_price.toLocaleString()}</small>
                </div>
                <div class="d-flex align-items-center gap-2">
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-secondary" onclick="changeQty(${index}, -1)">-</button>
                        <button class="btn btn-outline-secondary" onclick="changeQty(${index}, 1)">+</button>
                    </div>
                    <span class="fw-bold" style="min-width: 80px; text-align: right;">TZS ${subtotal.toLocaleString()}</span>
                    <button class="btn btn-sm btn-outline-danger" onclick="removeFromCart(${index})">
                        <i class="bi bi-x"></i>
                    </button>
                </div>
            </div>
        `;
    });

    container.innerHTML = html;
    totalEl.textContent = 'TZS ' + total.toLocaleString();
    countEl.textContent = totalItems;
    completeBtn.disabled = false;
    clearBtn.style.display = 'block';
}

function changeQty(index, delta) {
    const item = cart[index];
    const newQty = item.quantity + delta;

    if (newQty <= 0) {
        removeFromCart(index);
    } else if (newQty <= item.max_stock) {
        item.quantity = newQty;
        updateCart();
    } else {
        alert('Not enough stock!');
    }
}

function removeFromCart(index) {
    cart.splice(index, 1);
    updateCart();
}

document.getElementById('clear-cart').addEventListener('click', function() {
    if (confirm('Clear entire cart?')) {
        cart = [];
        updateCart();
    }
});

document.getElementById('complete-sale').addEventListener('click', async function() {
    if (cart.length === 0) return;

    const paymentMethod = document.getElementById('payment-method').value;
    this.disabled = true;
    this.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Processing...';

    try {
        const response = await fetch('/api/sales', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ items: cart, payment_method: paymentMethod })
        });

        const data = await response.json();

        if (data.success) {
            alert('Sale completed!\n\nTotal: TZS ' + data.total.toLocaleString() + '\nProfit: TZS ' + data.profit.toLocaleString());
            cart = [];
            updateCart();
            location.reload(); // Refresh to update stock
        } else {
            alert('Error completing sale: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        alert('Error: ' + error.message);
    } finally {
        this.disabled = false;
        this.innerHTML = '<i class="bi bi-check-circle"></i> Complete Sale';
    }
});
</script>
{% endblock %}